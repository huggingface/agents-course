<CourseFloatingBanner chapter={2}
  classNames="absolute z-10 right-0 top-0"
  notebooks={[
    {label: "Google Colab", value: "https://colab.research.google.com/github/huggingface/agents-course/blob/main/notebooks/bonus-unit2/monitoring-and-evaluating-agents.ipynb"},
]} />

# Ch∆∞∆°ng b·ªï tr·ª£ 2: Quan s√°t v√† ƒë√°nh gi√° Agent

<Tip>
B·∫°n c√≥ th·ªÉ theo d√µi code trong <a href="https://huggingface.co/agents-course/notebooks/blob/main/bonus-unit2/monitoring-and-evaluating-agents-notebook.ipynb" target="_blank">notebook n√†y</a> v√† ch·∫°y tr√™n Google Colab.
</Tip>

Trong notebook n√†y, ch√∫ng ta s·∫Ω h·ªçc c√°ch **gi√°m s√°t c√°c b∆∞·ªõc n·ªôi b·ªô (traces) c·ªßa AI Agent** v√† **ƒë√°nh gi√° hi·ªáu su·∫•t** b·∫±ng c√°c c√¥ng c·ª• quan s√°t m√£ ngu·ªìn m·ªü.

Kh·∫£ nƒÉng quan s√°t v√† ƒë√°nh gi√° h√†nh vi c·ªßa Agent l√† c·ª±c k·ª≥ quan tr·ªçng ƒë·ªÉ:
- G·ª° l·ªói khi t√°c v·ª• th·∫•t b·∫°i ho·∫∑c cho k·∫øt qu·∫£ kh√¥ng t·ªëi ∆∞u
- Theo d√µi chi ph√≠ v√† hi·ªáu su·∫•t theo th·ªùi gian th·ª±c
- C·∫£i thi·ªán ƒë·ªô tin c·∫≠y v√† an to√†n th√¥ng qua ph·∫£n h·ªìi li√™n t·ª•c

## Y√™u c·∫ßu tr∆∞·ªõc khi th·ª±c h√†nh üèóÔ∏è

Tr∆∞·ªõc khi ch·∫°y notebook n√†y, h√£y ƒë·∫£m b·∫£o b·∫°n ƒë√£:

üî≤ üìö  **H·ªçc xong** [Gi·ªõi thi·ªáu v·ªÅ Agent](https://huggingface.co/learn/agents-course/unit1/introduction)

üî≤ üìö  **H·ªçc xong** [Framework smolagents](https://huggingface.co/learn/agents-course/unit2/smolagents/introduction)

## B∆∞·ªõc 0: C√†i ƒë·∫∑t th∆∞ vi·ªán c·∫ßn thi·∫øt

Ch√∫ng ta c·∫ßn m·ªôt s·ªë th∆∞ vi·ªán ƒë·ªÉ ch·∫°y, gi√°m s√°t v√† ƒë√°nh gi√° Agent:

```python
%pip install 'smolagents[telemetry]'
%pip install opentelemetry-sdk opentelemetry-exporter-otlp openinference-instrumentation-smolagents
%pip install langfuse datasets 'smolagents[gradio]'
```

## B∆∞·ªõc 1: Thi·∫øt l·∫≠p instrumentation cho Agent

Trong notebook n√†y, ch√∫ng ta d√πng [Langfuse](https://langfuse.com/) l√†m c√¥ng c·ª• quan s√°t, nh∆∞ng b·∫°n c√≥ th·ªÉ d√πng **b·∫•t k·ª≥ d·ªãch v·ª• t∆∞∆°ng th√≠ch OpenTelemetry n√†o**. Code d∆∞·ªõi ƒë√¢y h∆∞·ªõng d·∫´n c√°ch thi·∫øt l·∫≠p bi·∫øn m√¥i tr∆∞·ªùng cho Langfuse (ho·∫∑c endpoint OTel kh√°c) v√† c√°ch instrumentation cho smolagent.

**L∆∞u √Ω:** N·∫øu d√πng LlamaIndex ho·∫∑c LangGraph, b·∫°n c√≥ th·ªÉ xem t√†i li·ªáu instrumentation [t·∫°i ƒë√¢y](https://langfuse.com/docs/integrations/llama-index/workflows) v√† [t·∫°i ƒë√¢y](https://langfuse.com/docs/integrations/langchain/example-python-langgraph).

ƒê·∫ßu ti√™n, h√£y c·∫•u h√¨nh bi·∫øn m√¥i tr∆∞·ªùng ƒë·ªÉ k·∫øt n·ªëi t·ªõi endpoint OpenTelemetry c·ªßa Langfuse.

```python
import os
import base64

# L·∫•y key c·ªßa b·∫°n t·ª´ https://cloud.langfuse.com
LANGFUSE_PUBLIC_KEY = "pk-lf-..." 
LANGFUSE_SECRET_KEY = "sk-lf-..." 
os.environ["LANGFUSE_PUBLIC_KEY"] = LANGFUSE_PUBLIC_KEY
os.environ["LANGFUSE_SECRET_KEY"] = LANGFUSE_SECRET_KEY
os.environ["LANGFUSE_HOST"] = "https://cloud.langfuse.com"  # üá™üá∫ V√≠ d·ª• cho khu v·ª±c EU
# os.environ["LANGFUSE_HOST"] = "https://us.cloud.langfuse.com"  # üá∫üá∏ V√≠ d·ª• cho khu v·ª±c US

LANGFUSE_AUTH = base64.b64encode(
    f"{LANGFUSE_PUBLIC_KEY}:{LANGFUSE_SECRET_KEY}".encode()
).decode()

os.environ["OTEL_EXPORTER_OTLP_ENDPOINT"] = os.environ.get("LANGFUSE_HOST") + "/api/public/otel"
os.environ["OTEL_EXPORTER_OTLP_HEADERS"] = f"Authorization=Basic {LANGFUSE_AUTH}"
```
Ch√∫ng ta c≈©ng c·∫ßn c·∫•u h√¨nh Hugging Face token cho c√°c l·ªánh inference.

```python
# Thi·∫øt l·∫≠p Hugging Face token v√† c√°c secret kh√°c d∆∞·ªõi d·∫°ng bi·∫øn m√¥i tr∆∞·ªùng
os.environ["HF_TOKEN"] = "hf_..." 
```
Ti·∫øp theo, thi·∫øt l·∫≠p tracer-provider cho OpenTelemetry ƒë√£ c·∫•u h√¨nh.

```python
from opentelemetry.sdk.trace import TracerProvider
from openinference.instrumentation.smolagents import SmolagentsInstrumentor
from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.trace.export import SimpleSpanProcessor
 
# T·∫°o TracerProvider cho OpenTelemetry
trace_provider = TracerProvider()

# Th√™m SimpleSpanProcessor v·ªõi OTLPSpanExporter ƒë·ªÉ g·ª≠i traces
trace_provider.add_span_processor(SimpleSpanProcessor(OTLPSpanExporter()))

# Thi·∫øt l·∫≠p tracer provider m·∫∑c ƒë·ªãnh to√†n c·ª•c