<CourseFloatingBanner chapter={2}
  classNames="absolute z-10 right-0 top-0"
  notebooks={[
    {label: "Google Colab", value: "https://colab.research.google.com/github/huggingface/agents-course/blob/main/notebooks/unit2/smolagents/vision_agents.ipynb"},
]} />

# CÃ¡c Agent thá»‹ giÃ¡c vá»›i smolagents

<Tip warning={true}>
CÃ¡c vÃ­ dá»¥ trong pháº§n nÃ y yÃªu cáº§u truy cáº­p vÃ o má»™t VLM model máº¡nh. ChÃºng mÃ¬nh Ä‘Ã£ thá»­ nghiá»‡m chÃºng báº±ng GPT-4o API.  
Tuy nhiÃªn, bÃ i viáº¿t <a href="./why_use_smolagents">Táº¡i sao nÃªn dÃ¹ng smolagents</a> tháº£o luáº­n vá» cÃ¡c giáº£i phÃ¡p thay tháº¿ Ä‘Æ°á»£c há»— trá»£ bá»Ÿi smolagents vÃ  Hugging Face. Náº¿u báº¡n muá»‘n khÃ¡m phÃ¡ cÃ¡c lá»±a chá»n khÃ¡c, hÃ£y xem qua pháº§n Ä‘Ã³.
</Tip>

Trao quyá»n xá»­ lÃ½ thá»‹ giÃ¡c cho cÃ¡c Agent lÃ  yáº¿u tá»‘ quan trá»ng Ä‘á»ƒ giáº£i quyáº¿t cÃ¡c tÃ¡c vá»¥ vÆ°á»£t ra ngoÃ i xá»­ lÃ½ vÄƒn báº£n. Nhiá»u thÃ¡ch thá»©c thá»±c táº¿ nhÆ° duyá»‡t web hay hiá»ƒu tÃ i liá»‡u Ä‘Ã²i há»i phÃ¢n tÃ­ch ná»™i dung hÃ¬nh áº£nh phong phÃº. May máº¯n thay, `smolagents` cung cáº¥p há»— trá»£ sáºµn cho cÃ¡c vision-language models (VLMs), giÃºp agent cÃ³ thá»ƒ xá»­ lÃ½ vÃ  phÃ¢n tÃ­ch hÃ¬nh áº£nh hiá»‡u quáº£.

Trong vÃ­ dá»¥ nÃ y, hÃ£y tÆ°á»Ÿng tÆ°á»£ng Alfred - quáº£n gia táº¡i Dinh Wayne - Ä‘Æ°á»£c giao nhiá»‡m vá»¥ xÃ¡c minh danh tÃ­nh cÃ¡c vá»‹ khÃ¡ch tham dá»± bá»¯a tiá»‡c. NhÆ° báº¡n cÃ³ thá»ƒ Ä‘oÃ¡n, Alfred cÃ³ thá»ƒ khÃ´ng quen biáº¿t táº¥t cáº£ má»i ngÆ°á»i. Äá»ƒ giÃºp Ã´ng áº¥y, ta cÃ³ thá»ƒ dÃ¹ng má»™t agent xÃ¡c minh danh tÃ­nh báº±ng cÃ¡ch tÃ¬m kiáº¿m thÃ´ng tin hÃ¬nh áº£nh vá» ngoáº¡i hÃ¬nh thÃ´ng qua VLM. Äiá»u nÃ y sáº½ giÃºp Alfred Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh sÃ¡ng suá»‘t vá» viá»‡c ai Ä‘Æ°á»£c phÃ©p vÃ o. HÃ£y cÃ¹ng xÃ¢y dá»±ng vÃ­ dá»¥ nÃ y!


## Cung cáº¥p hÃ¬nh áº£nh khi khá»Ÿi cháº¡y Agent

<Tip>
Báº¡n cÃ³ thá»ƒ theo dÃµi code trong <a href="https://huggingface.co/agents-course/notebooks/blob/main/unit2/smolagents/vision_agents.ipynb" target="_blank">notebook nÃ y</a> vÃ  cháº¡y trÃªn Google Colab.
</Tip>

Vá»›i cÃ¡ch tiáº¿p cáº­n nÃ y, hÃ¬nh áº£nh Ä‘Æ°á»£c truyá»n cho agent ngay tá»« Ä‘áº§u vÃ  lÆ°u dÆ°á»›i dáº¡ng `task_images` cÃ¹ng vá»›i prompt nhiá»‡m vá»¥. Agent sáº½ xá»­ lÃ½ cÃ¡c hÃ¬nh áº£nh nÃ y trong suá»‘t quÃ¡ trÃ¬nh cháº¡y.

XÃ©t trÆ°á»ng há»£p Alfred muá»‘n xÃ¡c minh danh tÃ­nh cÃ¡c siÃªu anh hÃ¹ng tham dá»± tiá»‡c. Ã”ng áº¥y Ä‘Ã£ cÃ³ sáºµn dataset hÃ¬nh áº£nh tá»« cÃ¡c bá»¯a tiá»‡c trÆ°á»›c vá»›i tÃªn khÃ¡ch má»i. Khi cÃ³ hÃ¬nh áº£nh khÃ¡ch má»›i, agent cÃ³ thá»ƒ so sÃ¡nh vá»›i dataset hiá»‡n cÃ³ vÃ  Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh.

Trong trÆ°á»ng há»£p nÃ y, má»™t vá»‹ khÃ¡ch Ä‘ang cá»‘ vÃ o cá»­a vÃ  Alfred nghi ngá» Ä‘Ã¢y lÃ  Joker Ä‘ang Ä‘Ã³ng giáº£ Wonder Woman. Alfred cáº§n xÃ¡c minh danh tÃ­nh Ä‘á»ƒ ngÄƒn káº» khÃ´ng mong muá»‘n vÃ o.

HÃ£y báº¯t Ä‘áº§u xÃ¢y dá»±ng vÃ­ dá»¥. Äáº§u tiÃªn, ta load cÃ¡c hÃ¬nh áº£nh. á» Ä‘Ã¢y chÃºng ta dÃ¹ng hÃ¬nh tá»« Wikipedia Ä‘á»ƒ minh há»a:

```python
from PIL import Image
import requests
from io import BytesIO

image_urls = [
    "https://upload.wikimedia.org/wikipedia/commons/e/e8/The_Joker_at_Wax_Museum_Plus.jpg", # áº¢nh Joker
    "https://upload.wikimedia.org/wikipedia/en/9/98/Joker_%28DC_Comics_character%29.jpg" # áº¢nh Joker
]

images = []
for url in image_urls:
    response = requests.get(url)
    image = Image.open(BytesIO(response.content)).convert("RGB")
    images.append(image)
```

Giá» Ä‘Ã¢y agent sáº½ cho chÃºng ta biáº¿t liá»‡u má»™t vá»‹ khÃ¡ch cÃ³ thá»±c sá»± lÃ  siÃªu anh hÃ¹ng (Wonder Woman) hay lÃ  pháº£n diá»‡n (The Joker).

```python
from smolagents import CodeAgent, OpenAIServerModel

model = OpenAIServerModel(model_id="gpt-4o")

# Khá»Ÿi táº¡o agent
agent = CodeAgent(
    tools=[],
    model=model,
    max_steps=20,
    verbosity_level=2
)

response = agent.run(
    """
    MÃ´ táº£ trang phá»¥c vÃ  trang Ä‘iá»ƒm cá»§a nhÃ¢n váº­t truyá»‡n tranh trong cÃ¡c áº£nh nÃ y vÃ  tráº£ vá» mÃ´ táº£.
    Cho biáº¿t vá»‹ khÃ¡ch nÃ y lÃ  The Joker hay Wonder Woman.
    """,
    images=images
)
```

Káº¿t quáº£ cháº¡y thá»­ cá»§a mÃ¬nh nhÆ° sau (káº¿t quáº£ cá»§a báº¡n cÃ³ thá»ƒ khÃ¡c):

```python
    {
        'Costume and Makeup - First Image': (
            'Ão khoÃ¡c tÃ­m vÃ  cÃ  váº¡t lá»¥a tÃ­m trÃªn Ã¡o sÆ¡ mi mÃ u vÃ ng mÃ¹ táº¡t.',
            'SÆ¡n máº·t tráº¯ng vá»›i cÃ¡c Ä‘Æ°á»ng nÃ©t phÃ³ng Ä‘áº¡i, lÃ´ng mÃ y Ä‘en, trang Ä‘iá»ƒm máº¯t xanh, mÃ´i Ä‘á» táº¡o ná»¥ cÆ°á»i rá»™ng.'
        ),
        'Costume and Makeup - Second Image': (
            'Vest Ä‘en vá»›i hoa cÃ i ve Ã¡o, cáº§m lÃ¡ bÃ i.',
            'Da xanh xao, tÃ³c xanh lÃ¡, mÃ´i Ä‘á» vá»›i ná»¥ cÆ°á»i khoÃ¡c lÃ¡c.'
        ),
        'Character Identity': 'NhÃ¢n váº­t nÃ y giá»‘ng vá»›i mÃ´ táº£ vá» The Joker tá»« truyá»‡n tranh.'
    }
```

TrÆ°á»ng há»£p nÃ y, káº¿t quáº£ cho tháº¥y Ä‘Ã¢y lÃ  káº» máº¡o danh nÃªn ta cÃ³ thá»ƒ ngÄƒn Joker vÃ o tiá»‡c!

## Thu tháº­p hÃ¬nh áº£nh Ä‘á»™ng trong quÃ¡ trÃ¬nh cháº¡y

<Tip>
Báº¡n cÃ³ thá»ƒ theo dÃµi code trong <a href="https://huggingface.co/agents-course/notebooks/blob/main/unit2/smolagents/vision_web_browser.py" target="_blank">file Python nÃ y</a>
</Tip>

CÃ¡ch tiáº¿p cáº­n trÆ°á»›c ráº¥t há»¯u Ã­ch nhÆ°ng trong trÆ°á»ng há»£p khÃ¡ch khÃ´ng cÃ³ trong database, ta cáº§n phÆ°Æ¡ng Ã¡n khÃ¡c. Má»™t giáº£i phÃ¡p lÃ  thu tháº­p hÃ¬nh áº£nh/thÃ´ng tin Ä‘á»™ng tá»« nguá»“n bÃªn ngoÃ i nhÆ° duyá»‡t web.

á» cÃ¡ch nÃ y, hÃ¬nh áº£nh Ä‘Æ°á»£c thÃªm Ä‘á»™ng vÃ o bá»™ nhá»› agent khi cháº¡y. CÃ¡c agent trong `smolagents` dá»±a trÃªn lá»›p `MultiStepAgent` - má»™t abstraction cá»§a framework ReAct. Lá»›p nÃ y hoáº¡t Ä‘á»™ng theo chu ká»³ cÃ³ cáº¥u trÃºc:

1. **SystemPromptStep:** LÆ°u prompt há»‡ thá»‘ng
2. **TaskStep:** Ghi nháº­n truy váº¥n ngÆ°á»i dÃ¹ng vÃ  input
3. **ActionStep:** Ghi láº¡i logs tá»« hÃ nh Ä‘á»™ng vÃ  káº¿t quáº£

CÃ¡ch tiáº¿p cáº­n nÃ y cho phÃ©p agent tÃ­ch há»£p thÃ´ng tin hÃ¬nh áº£nh Ä‘á»™ng vÃ  pháº£n á»©ng linh hoáº¡t. DÆ°á»›i Ä‘Ã¢y lÃ  sÆ¡ Ä‘á»“ minh há»a quy trÃ¬nh lÃ m viá»‡c Ä‘á»™ng:

![Thu tháº­p hÃ¬nh áº£nh Ä‘á»™ng](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/smolagents-can-see/diagram_adding_vlms_smolagents.png)

Giá» hÃ£y xÃ¢y dá»±ng vÃ­ dá»¥ hoÃ n chá»‰nh. Láº§n nÃ y Alfred muá»‘n toÃ n quyá»n kiá»ƒm soÃ¡t quy trÃ¬nh xÃ¡c minh qua duyá»‡t web. Ta cáº§n má»™t bá»™ tools má»›i cho agent, sá»­ dá»¥ng Selenium vÃ  Helium Ä‘á»ƒ tá»± Ä‘á»™ng hÃ³a trÃ¬nh duyá»‡t. HÃ£y cÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t:

```bash
pip install "smolagents[all]" helium selenium python-dotenv
```

ChÃºng ta cáº§n cÃ¡c tools duyá»‡t web nhÆ° `search_item_ctrl_f`, `go_back`, vÃ  `close_popups` Ä‘á»ƒ agent hÃ nh xá»­ nhÆ° ngÆ°á»i dÃ¹ng thá»±c:

```python
@tool
def search_item_ctrl_f(text: str, nth_result: int = 1) -> str:
    """
    TÃ¬m kiáº¿m text trÃªn trang hiá»‡n táº¡i báº±ng Ctrl + F vÃ  nháº£y Ä‘áº¿n káº¿t quáº£ thá»© n.
    Args:
        text: Chuá»—i cáº§n tÃ¬m
        nth_result: Vá»‹ trÃ­ káº¿t quáº£ cáº§n nháº£y Ä‘áº¿n (máº·c Ä‘á»‹nh: 1)
    """
    elements = driver.find_elements(By.XPATH, f"//*[contains(text(), '{text}')]")
    if nth_result > len(elements):
        raise Exception(f"Match nÂ°{nth_result} not found (only {len(elements)} matches found)")
    result = f"Found {len(elements)} matches for '{text}'."
    elem = elements[nth_result - 1]
    driver.execute_script("arguments[0].scrollIntoView(true);", elem)
    result += f"Focused on element {nth_result} of {len(elements)}"
    return result


@tool
def go_back() -> None:
    """Quay láº¡i trang trÆ°á»›c."""
    driver.back()


@tool
def close_popups() -> str:
    """
    ÄÃ³ng cÃ¡c pop-up/modal hiá»ƒn thá»‹ trÃªn trang. DÃ¹ng Ä‘á»ƒ táº¯t cÃ¡c cá»­a sá»• pop-up! KhÃ´ng Ã¡p dá»¥ng cho banner cookie.
    """
    webdriver.ActionChains(driver).send_keys(Keys.ESCAPE).perform()
```

ChÃºng ta cáº§n chá»©c nÄƒng chá»¥p mÃ n hÃ¬nh Ä‘á»ƒ VLM agent xá»­ lÃ½. Chá»©c nÄƒng nÃ y chá»¥p áº£nh vÃ  lÆ°u vÃ o `step_log.observations_images = [image.copy()]`:

```python
def save_screenshot(step_log: ActionStep, agent: CodeAgent) -> None:
    sleep(1.0)  # Chá» animation JavaScript trÆ°á»›c khi chá»¥p
    driver = helium.get_driver()
    current_step = step_log.step_number
    if driver is not None:
        for step_logs in agent.logs:  # XÃ³a áº£nh cÅ© Ä‘á»ƒ xá»­ lÃ½ tá»‘i Æ°u
            if isinstance(step_log, ActionStep) and step_log.step_number <= current_step - 2:
                step_logs.observations_images = None
        png_bytes = driver.get_screenshot_as_png()
        image = Image.open(BytesIO(png_bytes))
        print(f"ÄÃ£ chá»¥p áº£nh mÃ n hÃ¬nh trÃ¬nh duyá»‡t: {image.size} pixels")
        step_log.observations_images = [image.copy()]  # Táº¡o báº£n sao Ä‘á»ƒ Ä‘áº£m báº£o lÆ°u trá»¯

    # Cáº­p nháº­t thÃ´ng tin URL hiá»‡n táº¡i
    url_info = f"Current url: {driver.current_url}"
    step_log.observations = url_info if step_logs.observations is None else step_log.observations + "\n" + url_info
    return
```

HÃ m nÃ y Ä‘Æ°á»£c truyá»n vÃ o agent qua `step_callback` Ä‘á»ƒ kÃ­ch hoáº¡t sau má»—i bÆ°á»›c cháº¡y.

Giá» ta cÃ³ thá»ƒ táº¡o vision agent duyá»‡t web, cung cáº¥p cÃ¡c tools Ä‘Ã£ táº¡o cÃ¹ng `DuckDuckGoSearchTool` Ä‘á»ƒ thu tháº­p thÃ´ng tin xÃ¡c minh danh tÃ­nh:

```python
from smolagents import CodeAgent, OpenAIServerModel, DuckDuckGoSearchTool
model = OpenAIServerModel(model_id="gpt-4o")

agent = CodeAgent(
    tools=[DuckDuckGoSearchTool(), go_back, close_popups, search_item_ctrl_f],
    model=model,
    additional_authorized_imports=["helium"],
    step_callbacks=[save_screenshot],
    max_steps=20,
    verbosity_level=2,
)
```

Vá»›i setup nÃ y, Alfred Ä‘Ã£ sáºµn sÃ ng kiá»ƒm tra danh tÃ­nh khÃ¡ch má»i:

```python
agent.run("""
TÃ´i lÃ  Alfred, quáº£n gia Dinh Wayne, chá»‹u trÃ¡ch nhiá»‡m xÃ¡c minh danh tÃ­nh khÃ¡ch tá»›i dá»± tiá»‡c. Má»™t siÃªu anh hÃ¹ng tá»± nháº­n lÃ  Wonder Woman vá»«a Ä‘áº¿n cá»•ng.

HÃ£y tÃ¬m kiáº¿m hÃ¬nh áº£nh Wonder Woman vÃ  táº¡o mÃ´ táº£ chi tiáº¿t. Äá»“ng thá»i truy cáº­p Wikipedia Ä‘á»ƒ thu tháº­p thÃ´ng tin ngoáº¡i hÃ¬nh. Tá»« Ä‘Ã³ tÃ´i cÃ³ thá»ƒ quyáº¿t Ä‘á»‹nh cho phÃ©p cÃ´ áº¥y vÃ o hay khÃ´ng.
""" + helium_instructions)
```

ChÃºng ta thÃªm `helium_instructions` vÃ o prompt Ä‘á»ƒ Ä‘iá»u hÆ°á»›ng agent duyá»‡t web Ä‘Ãºng cÃ¡ch.

Xem cÃ¡ch hoáº¡t Ä‘á»™ng qua video sau:

<video controls>
  <source src="https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/unit2/smolagents/VisionBrowserAgent.mp4" type="video/mp4">
</video>

Káº¿t quáº£ cuá»‘i cÃ¹ng:

```python
Final answer: Wonder Woman thÆ°á»ng Ä‘Æ°á»£c mÃ´ táº£ máº·c Ã¡o ná»‹t ngá»±c Ä‘á» vÃ  vÃ ng, quáº§n/vÃ¡y xanh dÆ°Æ¡ng cÃ³ sao tráº¯ng, vÆ°Æ¡ng miá»‡n vÃ ng, vÃ²ng tay báº¡c vÃ  dÃ¢y thá»«ng vÃ ng Lasso of Truth. CÃ´ lÃ  CÃ´ng chÃºa Diana cá»§a Themyscira, Ä‘Æ°á»£c biáº¿t Ä‘áº¿n vá»›i tÃªn Diana Prince.
```

Váº­y lÃ  chÃºng ta Ä‘Ã£ táº¡o thÃ nh cÃ´ng bá»™ xÃ¡c minh danh tÃ­nh cho bá»¯a tiá»‡c! Alfred giá» Ä‘Ã£ cÃ³ cÃ´ng cá»¥ cáº§n thiáº¿t Ä‘á»ƒ Ä‘áº£m báº£o chá»‰ Ä‘Ãºng ngÆ°á»i Ä‘Æ°á»£c vÃ o. Má»i thá»© Ä‘Ã£ sáºµn sÃ ng cho má»™t bá»¯a tiá»‡c vui váº» táº¡i Dinh Wayne!


## Äá»c thÃªm

- [We just gave sight to smolagents](https://huggingface.co/blog/smolagents-can-see) - Blog mÃ´ táº£ chá»©c nÄƒng vision agent
- [Web Browser Automation with Agents ğŸ¤–ğŸŒ](https://huggingface.co/docs/smolagents/examples/web_browser) - VÃ­ dá»¥ vá» duyá»‡t web báº±ng vision agent
- [Web Browser Vision Agent Example](https://github.com/huggingface/smolagents/blob/main/src/smolagents/vision_web_browser.py) - VÃ­ dá»¥ vá» duyá»‡t web báº±ng vision agent