<CourseFloatingBanner chapter={2}
  classNames="absolute z-10 right-0 top-0"
  notebooks={[
    {label: "Google Colab", value: "https://colab.research.google.com/github/huggingface/agents-course/blob/main/notebooks/unit2/smolagents/retrieval_agents.ipynb"},
]} />

# X√¢y d·ª±ng h·ªá th·ªëng Agentic RAG

<Tip>
B·∫°n c√≥ th·ªÉ theo d√µi code trong <a href="https://huggingface.co/agents-course/notebooks/blob/main/unit2/smolagents/retrieval_agents.ipynb" target="_blank">notebook n√†y</a> v√† ch·∫°y b·∫±ng Google Colab.
</Tip>

H·ªá th·ªëng T√¨m ki·∫øm v√† T·∫°o ra c√¢u tr·∫£ l·ªùi (RAG) k·∫øt h·ª£p kh·∫£ nƒÉng t√¨m ki·∫øm d·ªØ li·ªáu v·ªõi m√¥ h√¨nh sinh n·ªôi dung ƒë·ªÉ ƒë∆∞a ra ph·∫£n h·ªìi theo ng·ªØ c·∫£nh. V√≠ d·ª•: truy v·∫•n ng∆∞·ªùi d√πng ƒë∆∞·ª£c ƒë∆∞a v√†o c√¥ng c·ª• t√¨m ki·∫øm, k·∫øt qu·∫£ t√¨m ƒë∆∞·ª£c c√πng v·ªõi truy v·∫•n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn cho m√¥ h√¨nh. M√¥ h√¨nh s·∫Ω sinh c√¢u tr·∫£ l·ªùi d·ª±a tr√™n c·∫£ truy v·∫•n v√† th√¥ng tin thu th·∫≠p ƒë∆∞·ª£c.

Agentic RAG m·ªü r·ªông h·ªá th·ªëng RAG truy·ªÅn th·ªëng b·∫±ng c√°ch **k·∫øt h·ª£p c√°c Agent t·ª± tr·ªã v·ªõi c∆° ch·∫ø thu th·∫≠p tri th·ª©c ƒë·ªông**. 

Trong khi h·ªá th·ªëng RAG truy·ªÅn th·ªëng d√πng LLM ƒë·ªÉ tr·∫£ l·ªùi d·ª±a tr√™n d·ªØ li·ªáu t√¨m ƒë∆∞·ª£c, Agentic RAG **cho ph√©p ki·ªÉm so√°t th√¥ng minh c·∫£ qu√° tr√¨nh thu th·∫≠p v√† sinh d·ªØ li·ªáu**, gi√∫p c·∫£i thi·ªán hi·ªáu qu·∫£ v√† ƒë·ªô ch√≠nh x√°c.

H·ªá th·ªëng RAG truy·ªÅn th·ªëng c√≥ m·ªôt s·ªë h·∫°n ch·∫ø nh∆∞ **ch·ªâ th·ª±c hi·ªán m·ªôt b∆∞·ªõc t√¨m ki·∫øm** v√† t·∫≠p trung v√†o ƒë·ªô t∆∞∆°ng ƒë·ªìng ng·ªØ nghƒ©a tr·ª±c ti·∫øp v·ªõi truy v·∫•n, c√≥ th·ªÉ b·ªè s√≥t th√¥ng tin li√™n quan.

Agentic RAG gi·∫£i quy·∫øt c√°c v·∫•n ƒë·ªÅ n√†y b·∫±ng c√°ch cho ph√©p Agent t·ª± ƒë·ªông x√¢y d·ª±ng truy v·∫•n t√¨m ki·∫øm, ƒë√°nh gi√° k·∫øt qu·∫£ v√† th·ª±c hi·ªán nhi·ªÅu b∆∞·ªõc thu th·∫≠p ƒë·ªÉ cho ra k·∫øt qu·∫£ to√†n di·ªán v√† ph√π h·ª£p h∆°n.

## T√¨m ki·∫øm c∆° b·∫£n v·ªõi DuckDuckGo

H√£y x√¢y d·ª±ng m·ªôt Agent ƒë∆°n gi·∫£n c√≥ th·ªÉ t√¨m ki·∫øm web b·∫±ng DuckDuckGo. Agent n√†y s·∫Ω thu th·∫≠p th√¥ng tin v√† t·ªïng h·ª£p c√¢u tr·∫£ l·ªùi cho c√°c truy v·∫•n. V·ªõi Agentic RAG, Agent c·ªßa Alfred c√≥ th·ªÉ:

* T√¨m ki·∫øm xu h∆∞·ªõng ti·ªác si√™u anh h√πng m·ªõi nh·∫•t
* L·ªçc k·∫øt qu·∫£ ƒë·ªÉ bao g·ªìm c√°c y·∫øu t·ªë sang tr·ªçng 
* T·ªïng h·ª£p th√¥ng tin th√†nh k·∫ø ho·∫°ch ho√†n ch·ªânh

ƒê√¢y l√† c√°ch Agent c·ªßa Alfred th·ª±c hi·ªán:

```python
from smolagents import CodeAgent, DuckDuckGoSearchTool, HfApiModel

# Kh·ªüi t·∫°o c√¥ng c·ª• t√¨m ki·∫øm
search_tool = DuckDuckGoSearchTool()

# Kh·ªüi t·∫°o model
model = HfApiModel()

agent = CodeAgent(
    model=model,
    tools=[search_tool]
)

# V√≠ d·ª• s·ª≠ d·ª•ng
response = agent.run(
    "T√¨m ki·∫øm √Ω t∆∞·ªüng ti·ªác si√™u anh h√πng sang tr·ªçng, bao g·ªìm trang tr√≠, gi·∫£i tr√≠ v√† ·∫©m th·ª±c."
)
print(response)
```

Agent th·ª±c hi·ªán theo quy tr√¨nh:

1. **Ph√¢n t√≠ch y√™u c·∫ßu:** Agent c·ªßa Alfred x√°c ƒë·ªãnh c√°c y·∫øu t·ªë ch√≠nh trong truy v·∫•n - k·∫ø ho·∫°ch ti·ªác si√™u anh h√πng sang tr·ªçng, t·∫≠p trung v√†o trang tr√≠, gi·∫£i tr√≠ v√† ·∫©m th·ª±c.
2. **Th·ª±c hi·ªán t√¨m ki·∫øm:** Agent s·ª≠ d·ª•ng DuckDuckGo ƒë·ªÉ t√¨m th√¥ng tin m·ªõi nh·∫•t v√† ph√π h·ª£p nh·∫•t v·ªõi s·ªü th√≠ch sang tr·ªçng c·ªßa Alfred.
3. **T·ªïng h·ª£p th√¥ng tin:** Sau khi thu th·∫≠p k·∫øt qu·∫£, Agent x·ª≠ l√Ω ch√∫ng th√†nh m·ªôt k·∫ø ho·∫°ch h√†nh ƒë·ªông m·∫°ch l·∫°c cho Alfred, bao qu√°t m·ªçi kh√≠a c·∫°nh c·ªßa b·ªØa ti·ªác.
4. **L∆∞u tr·ªØ ƒë·ªÉ tham kh·∫£o:** Agent l∆∞u th√¥ng tin ƒë√£ thu th·∫≠p ƒë·ªÉ d·ªÖ d√†ng truy c·∫≠p khi l√™n k·∫ø ho·∫°ch cho c√°c s·ª± ki·ªán t∆∞∆°ng lai.

## C√¥ng c·ª• tri th·ª©c chuy√™n bi·ªát

ƒê·ªëi v·ªõi c√°c t√°c v·ª• chuy√™n s√¢u, m·ªôt c∆° s·ªü tri th·ª©c t√πy ch·ªânh s·∫Ω r·∫•t h·ªØu √≠ch. H√£y t·∫°o c√¥ng c·ª• truy v·∫•n c∆° s·ªü d·ªØ li·ªáu vector ch·ª©a t√†i li·ªáu k·ªπ thu·∫≠t ho·∫∑c tri th·ª©c chuy√™n ng√†nh. S·ª≠ d·ª•ng t√¨m ki·∫øm ng·ªØ nghƒ©a, Agent c√≥ th·ªÉ t√¨m th√¥ng tin ph√π h·ª£p nh·∫•t v·ªõi nhu c·∫ßu c·ªßa Alfred.

C∆° s·ªü d·ªØ li·ªáu vector l∆∞u tr·ªØ bi·ªÉu di·ªÖn s·ªë (embedding) c·ªßa vƒÉn b·∫£n ho·∫∑c d·ªØ li·ªáu kh√°c, ƒë∆∞·ª£c t·∫°o b·ªüi c√°c m√¥ h√¨nh h·ªçc m√°y. N√≥ cho ph√©p t√¨m ki·∫øm ng·ªØ nghƒ©a b·∫±ng c√°ch x√°c ƒë·ªãnh c√°c √Ω nghƒ©a t∆∞∆°ng ƒë·ªìng trong kh√¥ng gian nhi·ªÅu chi·ªÅu.

C√°ch ti·∫øp c·∫≠n n√†y k·∫øt h·ª£p tri th·ª©c ƒë·ªãnh s·∫µn v·ªõi t√¨m ki·∫øm ng·ªØ nghƒ©a ƒë·ªÉ ƒë∆∞a ra gi·∫£i ph√°p theo ng·ªØ c·∫£nh cho vi·ªác l·∫≠p k·∫ø ho·∫°ch s·ª± ki·ªán. V·ªõi quy·ªÅn truy c·∫≠p v√†o tri th·ª©c chuy√™n s√¢u, Alfred c√≥ th·ªÉ ho√†n thi·ªán t·ª´ng chi ti·∫øt c·ªßa b·ªØa ti·ªác.

Trong v√≠ d·ª• n√†y, ch√∫ng ta s·∫Ω t·∫°o c√¥ng c·ª• truy xu·∫•t √Ω t∆∞·ªüng l·∫≠p k·∫ø ho·∫°ch ti·ªác t·ª´ c∆° s·ªü tri th·ª©c t√πy ch·ªânh. S·ª≠ d·ª•ng BM25 retriever ƒë·ªÉ t√¨m ki·∫øm v√† `RecursiveCharacterTextSplitter` ƒë·ªÉ chia t√†i li·ªáu th√†nh c√°c ƒëo·∫°n nh·ªè.

<details>
<summary>B·∫•m ƒë·ªÉ xem b·∫£n d·ªãch ti·∫øng Vi·ªát</summary>
```python
from langchain.docstore.document import Document
from langchain.text_splitter import RecursiveCharacterTextSplitter
from smolagents import Tool
from langchain_community.retrievers import BM25Retriever
from smolagents import CodeAgent, HfApiModel

class PartyPlanningRetrieverTool(Tool):
    name = "party_planning_retriever"
    description = "S·ª≠ d·ª•ng t√¨m ki·∫øm ng·ªØ nghƒ©a ƒë·ªÉ truy xu·∫•t √Ω t∆∞·ªüng l·∫≠p k·∫ø ho·∫°ch ti·ªác ph√π h·ª£p cho b·ªØa ti·ªác si√™u anh h√πng c·ªßa Alfred t·∫°i Wayne Manor."
    inputs = {
        "query": {
            "type": "string",
            "description": "Truy v·∫•n c·∫ßn th·ª±c hi·ªán. N√™n li√™n quan ƒë·∫øn l·∫≠p k·∫ø ho·∫°ch ti·ªác ho·∫∑c ch·ªß ƒë·ªÅ si√™u anh h√πng.",
        }
    }
    output_type = "string"

    def __init__(self, docs, **kwargs):
        super().__init__(**kwargs)
        self.retriever = BM25Retriever.from_documents(
            docs, k=5  # Truy xu·∫•t 5 t√†i li·ªáu ph√π h·ª£p nh·∫•t
        )

    def forward(self, query: str) -> str:
        assert isinstance(query, str), "Truy v·∫•n ph·∫£i l√† chu·ªói k√Ω t·ª±"

        docs = self.retriever.invoke(
            query,
        )
        return "\n√ù t∆∞·ªüng t√¨m ƒë∆∞·ª£c:\n" + "".join(
            [
                f"\n\n===== √ù t∆∞·ªüng {str(i)} =====\n" + doc.page_content
                for i, doc in enumerate(docs)
            ]
        )

# Gi·∫£ l·∫≠p c∆° s·ªü tri th·ª©c v·ªÅ l·∫≠p k·∫ø ho·∫°ch ti·ªác
party_ideas = [
    {"text": "Ti·ªác h√≥a trang si√™u anh h√πng sang tr·ªçng v·ªõi trang tr√≠ v√†ng v√† r√®m nhung.", "source": "√ù t∆∞·ªüng ti·ªác 1"},
    {"text": "Thu√™ DJ chuy√™n nghi·ªáp ch∆°i nh·∫°c ch·ªß ƒë·ªÅ si√™u anh h√πng nh∆∞ Batman v√† Wonder Woman.", "source": "√ù t∆∞·ªüng gi·∫£i tr√≠"},
    {"text": "Ph·ª•c v·ª• m√≥n ƒÉn ƒë·∫∑t t√™n theo si√™u anh h√πng nh∆∞ 'Sinh t·ªë xanh Hulk' v√† 'B√≤ b√≠t t·∫øt Iron Man'.", "source": "√ù t∆∞·ªüng ·∫©m th·ª±c"},
    {"text": "Trang tr√≠ v·ªõi bi·ªÉu t∆∞·ª£ng si√™u anh h√πng v√† h√¨nh chi·∫øu c√°c th√†nh ph·ªë nh∆∞ Gotham quanh ƒë·ªãa ƒëi·ªÉm.", "source": "√ù t∆∞·ªüng trang tr√≠"},
    {"text": "Tr·∫£i nghi·ªám VR t∆∞∆°ng t√°c n∆°i kh√°ch c√≥ th·ªÉ tham gia m√¥ ph·ªèng si√™u anh h√πng.", "source": "√ù t∆∞·ªüng gi·∫£i tr√≠"}
]

source_docs = [
    Document(page_content=doc["text"], metadata={"source": doc["source"]})
    for doc in party_ideas
]

# Chia t√†i li·ªáu th√†nh c√°c ƒëo·∫°n nh·ªè
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=500,
    chunk_overlap=50,
    add_start_index=True,
    strip_whitespace=True,
    separators=["\n\n", "\n", ".", " ", ""],
)
docs_processed = text_splitter.split_documents(source_docs)

# T·∫°o c√¥ng c·ª• truy xu·∫•t
party_planning_retriever = PartyPlanningRetrieverTool(docs_processed)

# Kh·ªüi t·∫°o Agent
agent = CodeAgent(tools=[party_planning_retriever], model=HfApiModel())

# V√≠ d·ª• s·ª≠ d·ª•ng
response = agent.run(
    "T√¨m √Ω t∆∞·ªüng cho b·ªØa ti·ªác si√™u anh h√πng sang tr·ªçng, bao g·ªìm gi·∫£i tr√≠, ·∫©m th·ª±c v√† trang tr√≠."
)

print(response)
```
</details>
```python
from langchain.docstore.document import Document
from langchain.text_splitter import RecursiveCharacterTextSplitter
from smolagents import Tool
from langchain_community.retrievers import BM25Retriever
from smolagents import CodeAgent, HfApiModel

class PartyPlanningRetrieverTool(Tool):
    name = "party_planning_retriever"
    description = "Uses semantic search to retrieve relevant party planning ideas for Alfred‚Äôs superhero-themed party at Wayne Manor."
    inputs = {
        "query": {
            "type": "string",
            "description": "The query to perform. This should be a query related to party planning or superhero themes.",
        }
    }
    output_type = "string"

    def __init__(self, docs, **kwargs):
        super().__init__(**kwargs)
        self.retriever = BM25Retriever.from_documents(
            docs, k=5  # Retrieve the top 5 documents
        )

    def forward(self, query: str) -> str:
        assert isinstance(query, str), "Your search query must be a string"

        docs = self.retriever.invoke(
            query,
        )
        return "\nRetrieved ideas:\n" + "".join(
            [
                f"\n\n===== Idea {str(i)} =====\n" + doc.page_content
                for i, doc in enumerate(docs)
            ]
        )

# M√¥ ph·ªèng c∆° s·ªü ki·∫øn ‚Äã‚Äãth·ª©c v·ªÅ l·∫≠p k·∫ø ho·∫°ch ti·ªác
party_ideas = [
    {"text": "A superhero-themed masquerade ball with luxury decor, including gold accents and velvet curtains.", "source": "Party Ideas 1"},
    {"text": "Hire a professional DJ who can play themed music for superheroes like Batman and Wonder Woman.", "source": "Entertainment Ideas"},
    {"text": "For catering, serve dishes named after superheroes, like 'The Hulk's Green Smoothie' and 'Iron Man's Power Steak.'", "source": "Catering Ideas"},
    {"text": "Decorate with iconic superhero logos and projections of Gotham and other superhero cities around the venue.", "source": "Decoration Ideas"},
    {"text": "Interactive experiences with VR where guests can engage in superhero simulations or compete in themed games.", "source": "Entertainment Ideas"}
]

source_docs = [
    Document(page_content=doc["text"], metadata={"source": doc["source"]})
    for doc in party_ideas
]

# Split the documents into smaller chunks
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=500,
    chunk_overlap=50,
    add_start_index=True,
    strip_whitespace=True,
    separators=["\n\n", "\n", ".", " ", ""],
)
docs_processed = text_splitter.split_documents(source_docs)

# Create the retriever tool
party_planning_retriever = PartyPlanningRetrieverTool(docs_processed)

# Initialize the agent
agent = CodeAgent(tools=[party_planning_retriever], model=HfApiModel())

# Example usage
response = agent.run(
    "Find ideas for a luxury superhero-themed party, including entertainment, catering, and decoration options."
)

print(response)
```

Agent n√¢ng cao n√†y c√≥ th·ªÉ:
1. Ki·ªÉm tra t√†i li·ªáu ƒë·ªÉ t√¨m th√¥ng tin li√™n quan
2. K·∫øt h·ª£p th√¥ng tin t·ª´ c∆° s·ªü tri th·ª©c
3. Duy tr√¨ ng·ªØ c·∫£nh h·ªôi tho·∫°i trong b·ªô nh·ªõ

## Kh·∫£ nƒÉng truy xu·∫•t n√¢ng cao

Khi x√¢y d·ª±ng h·ªá th·ªëng Agentic RAG, Agent c√≥ th·ªÉ √°p d·ª•ng c√°c chi·∫øn l∆∞·ª£c ph·ª©c t·∫°p nh∆∞:

1. **ƒê·ªãnh d·∫°ng l·∫°i truy v·∫•n:** Thay v√¨ d√πng truy v·∫•n th√¥, Agent c√≥ th·ªÉ t·ªëi ∆∞u h√≥a t·ª´ kh√≥a t√¨m ki·∫øm ƒë·ªÉ ph√π h·ª£p v·ªõi t√†i li·ªáu m·ª•c ti√™u
2. **Truy xu·∫•t ƒëa b∆∞·ªõc:** Agent c√≥ th·ªÉ th·ª±c hi·ªán nhi·ªÅu l·∫ßn t√¨m ki·∫øm, s·ª≠ d·ª•ng k·∫øt qu·∫£ ban ƒë·∫ßu ƒë·ªÉ c·∫£i thi·ªán truy v·∫•n ti·∫øp theo
3. **T√≠ch h·ª£p ngu·ªìn ƒëa d·∫°ng:** K·∫øt h·ª£p th√¥ng tin t·ª´ nhi·ªÅu ngu·ªìn nh∆∞ t√¨m ki·∫øm web v√† t√†i li·ªáu n·ªôi b·ªô
4. **X√°c th·ª±c k·∫øt qu·∫£:** Ph√¢n t√≠ch n·ªôi dung t√¨m ƒë∆∞·ª£c v·ªÅ ƒë·ªô li√™n quan v√† ch√≠nh x√°c tr∆∞·ªõc khi ƒë∆∞a v√†o c√¢u tr·∫£ l·ªùi

C√°c h·ªá th·ªëng Agentic RAG hi·ªáu qu·∫£ c·∫ßn xem x√©t k·ªπ l∆∞·ª°ng nhi·ªÅu kh√≠a c·∫°nh. Agent **c·∫ßn ch·ªçn l·ª±a c√¥ng c·ª• ph√π h·ª£p d·ª±a tr√™n lo·∫°i truy v·∫•n v√† ng·ªØ c·∫£nh**. H·ªá th·ªëng b·ªô nh·ªõ gi√∫p duy tr√¨ l·ªãch s·ª≠ h·ªôi tho·∫°i v√† tr√°nh truy xu·∫•t tr√πng l·∫∑p. C√°c chi·∫øn l∆∞·ª£c d·ª± ph√≤ng ƒë·∫£m b·∫£o h·ªá th·ªëng v·∫´n ho·∫°t ƒë·ªông ngay c·∫£ khi ph∆∞∆°ng ph√°p truy xu·∫•t ch√≠nh th·∫•t b·∫°i. B√™n c·∫°nh ƒë√≥, c√°c b∆∞·ªõc x√°c th·ª±c gi√∫p ƒë·∫£m b·∫£o t√≠nh ch√≠nh x√°c c·ªßa th√¥ng tin thu th·∫≠p.

## T√†i nguy√™n

- [Agentic RAG: turbocharge your RAG with query reformulation and self-query! üöÄ](https://huggingface.co/learn/cookbook/agent_rag) - C√¥ng th·ª©c ph√°t tri·ªÉn h·ªá th·ªëng Agentic RAG s·ª≠ d·ª•ng smolagents.