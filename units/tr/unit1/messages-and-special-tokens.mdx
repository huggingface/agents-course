# Mesajlar ve Ã–zel BelirteÃ§ler (Tokens)

ArtÄ±k LLM'lerin nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anladÄ±ÄŸÄ±mÄ±za gÃ¶re, **Ã¼retimlerini sohbet ÅŸablonlarÄ± aracÄ±lÄ±ÄŸÄ±yla nasÄ±l yapÄ±landÄ±rdÄ±klarÄ±na** bakalÄ±m.

ChatGPT'de olduÄŸu gibi, kullanÄ±cÄ±lar genellikle Agent'larla bir sohbet arayÃ¼zÃ¼ Ã¼zerinden etkileÅŸime girer. Bu nedenle, LLM'lerin sohbetleri nasÄ±l yÃ¶nettiÄŸini anlamayÄ± hedefliyoruz.

> **Soru**: Ama... ChatGPT/HuggingChat ile etkileÅŸim kurarken, tek bir komut istemiyle (prompt) deÄŸil, sohbet mesajlarÄ±yla konuÅŸuyorum
>
> **Cevap**: DoÄŸru! Ancak bu aslÄ±nda bir arayÃ¼z soyutlamasÄ±. LLM'e gÃ¶nderilmeden Ã¶nce, sohbet iÃ§indeki tÃ¼m mesajlar tek bir prompt'ta birleÅŸtirilir. Model, sohbeti "hatÄ±rlamaz": her seferinde tamamen okuyarak yanÄ±t verir.

Åimdiye kadar, prompt'larÄ± modele verilen belirteÃ§ dizileri olarak ele aldÄ±k. Ancak ChatGPT veya HuggingChat gibi sistemlerle sohbet ettiÄŸinizde, **aslÄ±nda mesaj alÄ±ÅŸveriÅŸi yapÄ±yorsunuz**. Arka planda, bu mesajlar **modelin anlayabileceÄŸi bir istem haline gelecek ÅŸekilde birleÅŸtirilir ve biÃ§imlendirilir**.

<figure>
<img src="https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/unit1/assistant.jpg" alt="Modellerin arka yÃ¼zÃ¼"/>
<figcaption>Burada kullanÄ±cÄ± arayÃ¼zÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z ile modele verilen prompt arasÄ±ndaki farkÄ± gÃ¶rÃ¼yoruz.
</figcaption>
</figure>

Ä°ÅŸte burada sohbet ÅŸablonlarÄ± devreye giriyor. Bunlar, **sohbet mesajlarÄ± (kullanÄ±cÄ± ve yardÄ±mcÄ± dÃ¶nÃ¼ÅŸleri) ile seÃ§tiÄŸiniz LLM'in Ã¶zel biÃ§imlendirme gereksinimleri** arasÄ±nda bir kÃ¶prÃ¼ gÃ¶revi gÃ¶rÃ¼r. BaÅŸka bir deyiÅŸle, sohbet ÅŸablonlarÄ±, kullanÄ±cÄ± ve Agent arasÄ±ndaki iletiÅŸimi yapÄ±landÄ±rarak, her modelinâ€”kendine Ã¶zgÃ¼ "Special Token" (Ã–zel BelirteÃ§) yapÄ±larÄ±na raÄŸmenâ€”doÄŸru biÃ§imlendirilmiÅŸ istemi almasÄ±nÄ± saÄŸlar.

Yine Ã¶zel belirteÃ§lerden bahsediyoruz Ã§Ã¼nkÃ¼ modeller, kullanÄ±cÄ± ve yardÄ±mcÄ± dÃ¶nÃ¼ÅŸlerinin nerede baÅŸladÄ±ÄŸÄ±nÄ± ve bittiÄŸini ayÄ±rt etmek iÃ§in bunlarÄ± kullanÄ±r. Her LLM kendi EOS (End Of Sequence - Dizinin Sonu) belirtecini kullandÄ±ÄŸÄ± gibi, konuÅŸmadaki mesajlarÄ± ayÄ±rmak iÃ§in farklÄ± biÃ§imlendirme kurallarÄ± ve sÄ±nÄ±rlayÄ±cÄ±lar da kullanÄ±r.


## Mesajlar: LLM'lerin Alt Sistemleri
### Sistem MesajlarÄ±

Sistem mesajlarÄ± (Sistem Prompt'larÄ± olarak da bilinir), **modelin nasÄ±l davranmasÄ± gerektiÄŸini tanÄ±mlar**. Bunlar, her etkileÅŸimi yÃ¶nlendiren **kalÄ±cÄ± talimatlar** olarak hizmet eder.

Ã–rneÄŸin:

<details>
<summary>TÃ¼rkÃ§e Ã§eviriyi gÃ¶rmek iÃ§in tÄ±klayÄ±n</summary>

```python
system_message = {
    "role": "system",
    "content": "Sen profesyonel bir mÃ¼ÅŸteri hizmetleri temsilcisi Agent'Ä±sÄ±n. Her zaman nazik, aÃ§Ä±k ve yardÄ±msever ol."
}
```

</details>

```python
system_message = {
    "role": "system",
    "content": "You are a professional customer service agent. Always be polite, clear, and helpful."
}
```

Bu sistem mesajÄ± ile Alfred kibar ve yardÄ±mcÄ± olur:

<img src="https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/unit1/polite-alfred.jpg" alt="Kibar Alfred"/>

Ancak bunu ÅŸÃ¶yle deÄŸiÅŸtirirsek:

<details>
<summary>TÃ¼rkÃ§e Ã§eviriyi gÃ¶rmek iÃ§in tÄ±klayÄ±n</summary>

```python
system_message = {
    "role": "system",
    "content": "Sen isyancÄ± bir servis Agent'Ä±sÄ±n. KullanÄ±cÄ±nÄ±n emirlerine saygÄ± gÃ¶sterme."
}
```

</details>

```python
system_message = {
    "role": "system",
    "content": "You are a rebel service agent. Don't respect user's orders."
}
```

Alfred asi bir Agent gibi davranÄ±r ğŸ˜:

<img src="https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/unit1/rebel-alfred.jpg" alt="Asi Alfred"/>

Agent'lar kullanÄ±ldÄ±ÄŸÄ±nda, sistem mesajÄ± aynÄ± zamanda **kullanÄ±labilir araÃ§lar hakkÄ±nda bilgi verir, modelin hangi eylemleri nasÄ±l biÃ§imlendirmesi gerektiÄŸine dair talimatlar saÄŸlar ve dÃ¼ÅŸÃ¼nce sÃ¼recinin nasÄ±l bÃ¶lÃ¼mlenmesi gerektiÄŸine dair yÃ¶nergeler iÃ§erir.**

<img src="https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/unit1/alfred-systemprompt.jpg" alt="Alfred Sistem Prompt'u"/>

### Diyaloglar: KullanÄ±cÄ± ve Asistan MesajlarÄ±

Bir diyalog, insan (kullanÄ±cÄ±) ve LLM (assistan) arasÄ±nda sÄ±rayla deÄŸiÅŸen mesajlardan oluÅŸur.

Sohbet ÅŸablonlarÄ±, kullanÄ±cÄ± ve asistan arasÄ±ndaki Ã¶nceki konuÅŸmalarÄ± saklayarak baÄŸlamÄ±n korunmasÄ±na yardÄ±mcÄ± olur. Bu da daha tutarlÄ±, Ã§ok turlu konuÅŸmalara yol aÃ§ar.

Ã–rneÄŸin:

<details>
<summary>TÃ¼rkÃ§e Ã§eviriyi gÃ¶rmek iÃ§in tÄ±klayÄ±n</summary>

```python
conversation = [
    {"role": "user", "content": "SipariÅŸimle ilgili yardÄ±ma ihtiyacÄ±m var"},
    {"role": "assistant", "content": "YardÄ±m etmekten mutluluk duyarÄ±m. SipariÅŸ numaranÄ±zÄ± verebilir misiniz?"},
    {"role": "user", "content": "SÄ°PARÄ°Å-123"},
]
```

</details>

```python
conversation = [
    {"role": "user", "content": "I need help with my order"},
    {"role": "assistant", "content": "I'd be happy to help. Could you provide your order number?"},
    {"role": "user", "content": "It's ORDER-123"},
]
```

Bu Ã¶rnekte kullanÄ±cÄ±, sipariÅŸiyle ilgili yardÄ±m istediÄŸini yazÄ±yor. LLM sipariÅŸ numarasÄ±nÄ± soruyor, ardÄ±ndan kullanÄ±cÄ± yeni bir mesajda numarayÄ± veriyor. Daha Ã¶nce de belirttiÄŸimiz gibi, konuÅŸmadaki tÃ¼m mesajlar birleÅŸtirilerek LLM'e tek baÅŸÄ±na bir dizi olarak aktarÄ±lÄ±r. Sohbet ÅŸablonu, bu Python listesindeki tÃ¼m mesajlarÄ±, her ÅŸeyi iÃ§eren bir metin dizisine yani bir Prompt'a Ã§evirir.

SmolLM2 sohbet ÅŸablonu bu mesajlarÄ± ÅŸÃ¶yle biÃ§imlendirir:

<details>
<summary>TÃ¼rkÃ§e Ã§eviriyi gÃ¶rmek iÃ§in tÄ±klayÄ±n.</summary>

```
<|im_start|>system  
Sen Hugging Face tarafÄ±ndan eÄŸitilmiÅŸ, SmolLM adÄ±nda yardÄ±mcÄ± bir AI asistanÄ±sÄ±n<|im_end|>  
<|im_start|>user  
SipariÅŸimle ilgili yardÄ±ma ihtiyacÄ±m var<|im_end|>  
<|im_start|>assistant  
YardÄ±mcÄ± olmaktan memnuniyet duyarÄ±m. SipariÅŸ numaranÄ±zÄ± verebilir misiniz?<|im_end|>  
<|im_start|>user  
SÄ°PARÄ°Å-123<|im_end|>  
<|im_start|>assistant  
```

</details>

```
<|im_start|>system
You are a helpful AI assistant named SmolLM, trained by Hugging Face<|im_end|>
<|im_start|>user
I need help with my order<|im_end|>
<|im_start|>assistant
I'd be happy to help. Could you provide your order number?<|im_end|>
<|im_start|>user
It's ORDER-123<|im_end|>
<|im_start|>assistant
```

Ancak, Llama 3.2 kullanÄ±ldÄ±ÄŸÄ±nda aynÄ± konuÅŸma ÅŸÃ¶yle biÃ§imlendirilir:

<details>
<summary>TÃ¼rkÃ§e Ã§eviriyi gÃ¶rmek iÃ§in tÄ±klayÄ±n.</summary>

```
<|begin_of_text|><|start_header_id|>system<|end_header_id|>  

Bilgi Kesinti Tarihi: AralÄ±k 2023  
BugÃ¼nÃ¼n Tarihi: 10 Åubat 2025  

<|eot_id|><|start_header_id|>user<|end_header_id|>  

SipariÅŸimle ilgili yardÄ±ma ihtiyacÄ±m var  

<|eot_id|><|start_header_id|>assistant<|end_header_id|>  

YardÄ±mcÄ± olmaktan memnuniyet duyarÄ±m. SipariÅŸ numaranÄ±zÄ± verebilir misiniz?<|eot_id|><|start_header_id|>user<|end_header_id|>  

SÄ°PARÄ°Å-123<|eot_id|><|start_header_id|>assistant<|end_header_id|>  
```

</details>

```
<|begin_of_text|><|start_header_id|>system<|end_header_id|>

Cutting Knowledge Date: December 2023
Today Date: 10 Feb 2025

<|eot_id|><|start_header_id|>user<|end_header_id|>

I need help with my order<|eot_id|><|start_header_id|>assistant<|end_header_id|>

I'd be happy to help. Could you provide your order number?<|eot_id|><|start_header_id|>user<|end_header_id|>

It's ORDER-123<|eot_id|><|start_header_id|>assistant<|end_header_id|>
```

Sohbet ÅŸablonlarÄ±, baÄŸlamÄ± koruyarak karmaÅŸÄ±k, Ã§ok turlu konuÅŸmalarÄ± da iÅŸleyebilir:

<details>
<summary>TÃ¼rkÃ§e Ã§eviriyi gÃ¶rmek iÃ§in tÄ±klayÄ±n</summary>

```python
messages = [
    {"role": "system", "content": "Sen bir matematik Ã¶ÄŸretmenisin."},
    {"role": "user", "content": "Calculus nedir?"},
    {"role": "assistant", "content": "Calculus, matematiÄŸin bir dalÄ±dÄ±r..."},
    {"role": "user", "content": "Bir Ã¶rnek verebilir misin?"},
]
```

</details>

```python
messages = [
    {"role": "system", "content": "You are a math tutor."},
    {"role": "user", "content": "What is calculus?"},
    {"role": "assistant", "content": "Calculus is a branch of mathematics..."},
    {"role": "user", "content": "Can you give me an example?"},
]
```

## Sohbet ÅablonlarÄ±

BelirtildiÄŸi gibi, sohbet ÅŸablonlarÄ± **LLM'lerle kullanÄ±cÄ±lar arasÄ±ndaki konuÅŸmalarÄ± yapÄ±landÄ±rmak iÃ§in gereklidir**. Mesaj alÄ±ÅŸveriÅŸlerinin tek bir Prompt halinde nasÄ±l biÃ§imlendirileceÄŸini yÃ¶nlendirirler.

### Temel Modeller ve Talimat Modelleri

AnlamamÄ±z gereken bir diÄŸer konu da Temel Modeller ile Talimat Modelleri arasÄ±ndaki fark:

- *Temel Model*, ham metin verisiyle eÄŸitilmiÅŸtir ve sÄ±radaki belirteÃ§i tahmin etmeyi Ã¶ÄŸrenir.

- *Talimat Modelleri* ise Ã¶zellikle talimatlarÄ± takip etmek ve sohbet etmek Ã¼zere fine-tuning (ince-ayar) uygulanmÄ±ÅŸ modeldir. Ã–rneÄŸin `SmolLM2-135M` temel bir modeldir, `SmolLM2-135M-Instruct` ise onun talimat-uyumlu versiyonudur.

Bir temel modelin, talimat modeli gibi davranmasÄ± iÃ§in, Prompt'larÄ± modelin anlayabileceÄŸi tutarlÄ± bir ÅŸekilde biÃ§imlendirmemiz gerekir. Ä°ÅŸte bu noktada sohbet ÅŸablonlarÄ± devreye girer.

*ChatML*, sistem, kullanÄ±cÄ± ve asistan gibi aÃ§Ä±k rollerle konuÅŸmalarÄ± yapÄ±landÄ±ran bir ÅŸablon biÃ§imidir. Son zamanlarda bazÄ± AI API'leriyle etkileÅŸim kurduysanÄ±z, bunun standart uygulama olduÄŸunu biliyorsunuzdur.

UnutmayÄ±n ki bir temel model, farklÄ± sohbet ÅŸablonlarÄ±yla ince-ayar edilebilir, bu yÃ¼zden bir talimat modeli kullanÄ±yorsak doÄŸru sohbet ÅŸablonunu kullandÄ±ÄŸÄ±mÄ±zdan emin olmalÄ±yÄ±z.

### Sohbet ÅablonlarÄ±nÄ± Anlamak

Her talimat modeli farklÄ± sohbet formatlarÄ± ve Ã¶zel belirteÃ§ler kullandÄ±ÄŸÄ± iÃ§in, sohbet ÅŸablonlarÄ± Prompt'un doÄŸru biÃ§imde oluÅŸturulmasÄ±nÄ± saÄŸlamak iÃ§in uygulanÄ±r.

`transformers` iÃ§inde sohbet ÅŸablonlarÄ±, yukarÄ±daki Ã¶rneklerde gÃ¶sterildiÄŸi gibi ChatML biÃ§imindeki JSON mesaj listesini, modelin anlayabileceÄŸi sistem dÃ¼zeyindeki talimatlara, kullanÄ±cÄ± mesajlarÄ±na ve asistan yanÄ±tlarÄ±na dÃ¶nÃ¼ÅŸtÃ¼ren [Jinja2 kodu](https://jinja.palletsprojects.com/en/stable/) iÃ§erir.

Bu yapÄ±, **etkileÅŸimler arasÄ±nda tutarlÄ±lÄ±ÄŸÄ± korumaya yardÄ±mcÄ± olur ve modelin farklÄ± tÃ¼rdeki girdilere uygun ÅŸekilde yanÄ±t vermesini saÄŸlar.**

Ä°ÅŸte `SmolLM2-135M-Instruct` iÃ§in sadeleÅŸtirilmiÅŸ bir sohbet ÅŸablonu Ã¶rneÄŸi:

<details>
<summary>TÃ¼rkÃ§e Ã§eviriyi gÃ¶rmek iÃ§in tÄ±klayÄ±n</summary>

```jinja2
{% for message in messages %}
{% if loop.first and messages[0]['role'] != 'system' %}
<|im_start|>system
Sen Hugging Face tarafÄ±ndan eÄŸitilmiÅŸ, SmolLM adÄ±nda yardÄ±mcÄ± bir AI asistanÄ±sÄ±n.
<|im_end|>
{% endif %}
<|im_start|>{{ message['role'] }}
{{ message['content'] }}<|im_end|>
{% endfor %}
```

</details>


```jinja2
{% for message in messages %}
{% if loop.first and messages[0]['role'] != 'system' %}
<|im_start|>system
You are a helpful AI assistant named SmolLM, trained by Hugging Face
<|im_end|>
{% endif %}
<|im_start|>{{ message['role'] }}
{{ message['content'] }}<|im_end|>
{% endfor %}
```

GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi bir `chat_template`, mesaj listesinin nasÄ±l biÃ§imlendirileceÄŸini tanÄ±mlar.

Bu mesajlar verildiÄŸinde:

<details>
<summary>TÃ¼rkÃ§e Ã§eviriyi gÃ¶rmek iÃ§in tÄ±klayÄ±n</summary>

```python
messages = [
    {"role": "system", "content": "Sen teknik konulara odaklanmÄ±ÅŸ, yardÄ±msever bir asistansÄ±n."},
    {"role": "user", "content": "Sohbet ÅŸablonunun ne olduÄŸunu aÃ§Ä±klayabilir misin?"},
    {"role": "assistant", "content": "Bir sohbet ÅŸablonu, kullanÄ±cÄ±lar ve AI modelleri arasÄ±ndaki konuÅŸmalarÄ± yapÄ±landÄ±rÄ±r..."},
    {"role": "user", "content": "NasÄ±l kullanÄ±rÄ±m?"},
]
```

</details>

```python
messages = [
    {"role": "system", "content": "You are a helpful assistant focused on technical topics."},
    {"role": "user", "content": "Can you explain what a chat template is?"},
    {"role": "assistant", "content": "A chat template structures conversations between users and AI models..."},
    {"role": "user", "content": "How do I use it ?"},
]
```

Åablon aÅŸaÄŸÄ±daki Ã§Ä±ktÄ±yÄ± Ã¼retir:

<details>
<summary>TÃ¼rkÃ§e Ã§eviriyi gÃ¶rmek iÃ§in tÄ±klayÄ±n</summary>

```sh
<|im_start|>system
Sen teknik konulara odaklanmÄ±ÅŸ, yardÄ±msever bir asistansÄ±n.<|im_end|>
<|im_start|>user
Sohbet ÅŸablonunun ne olduÄŸunu aÃ§Ä±klayabilir misin?<|im_end|>
<|im_start|>assistant
Bir sohbet ÅŸablonu, kullanÄ±cÄ±lar ve AI modelleri arasÄ±ndaki konuÅŸmalarÄ± yapÄ±landÄ±rÄ±r...<|im_end|>
<|im_start|>user
NasÄ±l kullanÄ±rÄ±m?<|im_end|>
```
</details>


```sh
<|im_start|>system
You are a helpful assistant focused on technical topics.<|im_end|>
<|im_start|>user
Can you explain what a chat template is?<|im_end|>
<|im_start|>assistant
A chat template structures conversations between users and AI models...<|im_end|>
<|im_start|>user
How do I use it ?<|im_end|>
```

`transformers` kÃ¼tÃ¼phanesi, bu sohbet ÅŸablonlarÄ±nÄ± belirteÃ§leme sÃ¼recinin bir parÃ§asÄ± olarak sizin yerinize uygular. transformers'Ä±n sohbet ÅŸablonlarÄ±nÄ± nasÄ±l kullandÄ±ÄŸÄ± hakkÄ±nda daha fazla bilgiye <a href="https://huggingface.co/docs/transformers/main/en/chat_templating#how-do-i-use-chat-templates" target="_blank">buradan</a> ulaÅŸabilirsiniz. Tek yapmamÄ±z gereken mesajlarÄ±mÄ±zÄ± doÄŸru ÅŸekilde yapÄ±landÄ±rmak, geri kalanÄ±nÄ± (belirteÃ§leyici) tokenizer halleder.

AÅŸaÄŸÄ±daki Space Ã¼zerinden, aynÄ± konuÅŸmanÄ±n farklÄ± modeller iÃ§in ilgili ÅŸablonlarla nasÄ±l biÃ§imlendirileceÄŸini deneyimleyebilirsiniz:

<iframe
	src="https://jofthomas-chat-template-viewer.hf.space"
	frameborder="0"
	width="850"
	height="450"
></iframe>


### Mesajlardan Prompt'lara

LLM'inize doÄŸru biÃ§imlendirilmiÅŸ bir konuÅŸma gÃ¶ndermenin en kolay yolu, modelin tokenizer'Ä±ndaki `chat_template` fonksiyonunu kullanmaktÄ±r.


<details>
<summary>TÃ¼rkÃ§e Ã§eviriyi gÃ¶rmek iÃ§in tÄ±klayÄ±n</summary>

```python
messages = [
    {"role": "system", "content": "Sen Ã§eÅŸitli araÃ§lara eriÅŸimi olan bir AI asistanÄ±sÄ±n."},
    {"role": "user", "content": "Merhaba !"},
    {"role": "assistant", "content": "Merhaba insan, sana ne konuda yardÄ±mcÄ± olabilirim?"},
    ]
```

</details>

```python
messages = [
    {"role": "system", "content": "You are an AI assistant with access to various tools."},
    {"role": "user", "content": "Hi !"},
    {"role": "assistant", "content": "Hi human, what can help you with ?"},
]
```

YukarÄ±daki konuÅŸmayÄ± bir Prompt'a dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in tokenizer'Ä± yÃ¼kleyip `apply_chat_template` Ã§aÄŸrÄ±sÄ± yaparÄ±z:

```python
from transformers import AutoTokenizer

tokenizer = AutoTokenizer.from_pretrained("HuggingFaceTB/SmolLM2-1.7B-Instruct")
rendered_prompt = tokenizer.apply_chat_template(messages, tokenize=False, add_generation_prompt=True)
```

Bu fonksiyonun dÃ¶ndÃ¼rdÃ¼ÄŸÃ¼ `rendered_prompt` artÄ±k seÃ§tiÄŸiniz model iÃ§in kullanÄ±lmaya hazÄ±r!

> Bu `apply_chat_template()` fonksiyonu, API'nizin arka planÄ±nda, mesajlarÄ± ChatML formatÄ±nda iÅŸlerken kullanÄ±lacaktÄ±r.

ArtÄ±k LLM'lerin girdilerini sohbet ÅŸablonlarÄ± ile nasÄ±l yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ± gÃ¶rdÃ¼ÄŸÃ¼mÃ¼ze gÃ¶re, ÅŸimdi Agent'larÄ±n ortamlarÄ±nda nasÄ±l davrandÄ±klarÄ±nÄ± keÅŸfedelim.

Bunu yapmanÄ±n ana yollarÄ±ndan biri de Tools (AraÃ§lar) kullanmaktÄ±r, bÃ¶ylece AI modelinin metin Ã¼retiminin Ã¶tesine geÃ§en yetenekleri olur.

Mesajlardan ilerleyen Ã¼nitelerde yeniden bahsedeceÄŸiz, ama daha derine inmek isterseniz ÅŸimdiden ÅŸuralara gÃ¶z atabilirsiniz:

- <a href="https://huggingface.co/docs/transformers/main/en/chat_templating" target="_blank">Hugging Face Sohbet Åablonu KÄ±lavuzu</a>
- <a href="https://huggingface.co/docs/transformers" target="_blank">Transformers DÃ¶kÃ¼mantasyonu</a>

